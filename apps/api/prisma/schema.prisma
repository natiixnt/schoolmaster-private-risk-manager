generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SCHOOL_ADMIN
  DIRECTOR
  TEACHER
  COUNSELOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum StudentStatus {
  ACTIVE
  GRADUATED
  LEFT
}

enum GradeType {
  PARTIAL
  SEMESTER
  EXAM
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  JUSTIFIED_ABSENT
}

enum BehaviorType {
  INCIDENT
  PRAISE
  WARNING
  NOTE
}

enum BehaviorSeverity {
  LOW
  MEDIUM
  HIGH
}

enum RiskLevel {
  GREEN
  YELLOW
  RED
}

enum ParentIssueCategory {
  COMPLAINT
  QUESTION
  SUGGESTION
  PRAISE
  OTHER
}

enum ParentIssueStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED_NO_ACTION
}

enum ParentIssuePriority {
  LOW
  MEDIUM
  HIGH
}

enum StudentActionPlanStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum StudentActionItemStatus {
  TODO
  IN_PROGRESS
  DONE
}

model School {
  id        String   @id @default(uuid())
  name      String
  type      String
  city      String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
  classes   Class[]
  students  Student[]
  riskIndicatorDefinitions RiskIndicatorDefinition[]
  parentIssues ParentIssue[]
}

model User {
  id             String       @id @default(uuid())
  schoolId       String
  email          String       @unique
  hashedPassword String
  role           UserRole
  status         UserStatus   @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  school         School       @relation(fields: [schoolId], references: [id])
  refreshTokens  RefreshToken[]
  classes        Class[]      @relation("TeacherClasses")
  behaviorEvents BehaviorEvent[] @relation("BehaviorAuthor")
  parentIssuesAssigned ParentIssue[] @relation("IssueAssignee")
  parentIssueComments ParentIssueComment[]
  actionPlansCreated StudentActionPlan[] @relation("PlanCreator")
  actionItemsOwned StudentActionItem[] @relation("ActionItemOwner")
}

model Class {
  id                 String    @id @default(uuid())
  schoolId           String
  name               String
  yearLevel          Int?
  homeroomTeacherId  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  school             School    @relation(fields: [schoolId], references: [id])
  homeroomTeacher    User?     @relation("TeacherClasses", fields: [homeroomTeacherId], references: [id])
  students           Student[]
  assessments        Assessment[]
  attendances        Attendance[]
  behaviorEvents     BehaviorEvent[]

  @@unique([schoolId, name])
}

model Student {
  id         String         @id @default(uuid())
  schoolId   String
  classId    String
  firstName  String
  lastName   String
  externalId String?
  status     StudentStatus  @default(ACTIVE)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  school     School         @relation(fields: [schoolId], references: [id])
  class      Class          @relation(fields: [classId], references: [id])
  assessments Assessment[]
  attendances Attendance[]
  behaviorEvents BehaviorEvent[]
  riskScores  RiskScore[]
  riskIndicatorValues RiskIndicatorValue[]
  parentIssues ParentIssue[]
  actionPlans StudentActionPlan[]

  @@index([schoolId])
  @@index([classId])
  @@index([schoolId, externalId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Assessment {
  id         String    @id @default(uuid())
  studentId  String
  classId    String?
  subject    String
  gradeValue Decimal
  gradeType  GradeType
  date       DateTime
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  student    Student   @relation(fields: [studentId], references: [id])
  class      Class?    @relation(fields: [classId], references: [id])

  @@index([studentId])
  @@index([classId])
}

model Attendance {
  id         String            @id @default(uuid())
  studentId  String
  classId    String?
  date       DateTime
  lessonNo   Int?
  status     AttendanceStatus
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  student    Student           @relation(fields: [studentId], references: [id])
  class      Class?            @relation(fields: [classId], references: [id])

  @@index([studentId])
  @@index([classId])
}

model BehaviorEvent {
  id               String            @id @default(uuid())
  studentId        String
  classId          String?
  type             BehaviorType
  severity         BehaviorSeverity
  description      String?
  createdByUserId  String
  date             DateTime
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  student          Student           @relation(fields: [studentId], references: [id])
  class            Class?            @relation(fields: [classId], references: [id])
  createdBy        User              @relation("BehaviorAuthor", fields: [createdByUserId], references: [id])

  @@index([studentId])
  @@index([classId])
  @@index([createdByUserId])
}

model RiskIndicatorDefinition {
  id          String   @id @default(uuid())
  schoolId    String?
  name        String
  description String
  configJson  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  school      School?  @relation(fields: [schoolId], references: [id])
  values      RiskIndicatorValue[]
}

model RiskIndicatorValue {
  id            String        @id @default(uuid())
  studentId     String
  indicatorId   String
  value         Json
  level         RiskLevel
  calculatedAt  DateTime
  student       Student       @relation(fields: [studentId], references: [id])
  indicator     RiskIndicatorDefinition @relation(fields: [indicatorId], references: [id])

  @@index([studentId])
  @@index([indicatorId])
}

model RiskScore {
  id            String     @id @default(uuid())
  studentId     String
  score         Int
  level         RiskLevel
  calculatedAt  DateTime
  student       Student    @relation(fields: [studentId], references: [id])

  @@unique([studentId])
  @@index([level])
}

model ParentIssue {
  id                String               @id @default(uuid())
  schoolId          String
  studentId         String?
  guardianId        String?
  category          ParentIssueCategory
  title             String
  description       String
  status            ParentIssueStatus    @default(NEW)
  priority          ParentIssuePriority  @default(MEDIUM)
  assignedToUserId  String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  closedAt          DateTime?
  school            School               @relation(fields: [schoolId], references: [id])
  student           Student?             @relation(fields: [studentId], references: [id])
  assignedTo        User?                @relation("IssueAssignee", fields: [assignedToUserId], references: [id])
  comments          ParentIssueComment[]

  @@index([schoolId])
  @@index([studentId])
  @@index([assignedToUserId])
}

model ParentIssueComment {
  id           String      @id @default(uuid())
  issueId      String
  authorUserId String
  comment      String
  createdAt    DateTime    @default(now())
  issue        ParentIssue @relation(fields: [issueId], references: [id])
  author       User        @relation(fields: [authorUserId], references: [id])

  @@index([issueId])
  @@index([authorUserId])
}

model StudentActionPlan {
  id               String                  @id @default(uuid())
  studentId        String
  createdByUserId  String
  goal             String
  status           StudentActionPlanStatus @default(OPEN)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  student          Student                 @relation(fields: [studentId], references: [id])
  createdBy        User                    @relation("PlanCreator", fields: [createdByUserId], references: [id])
  items            StudentActionItem[]

  @@index([studentId])
  @@index([createdByUserId])
}

model StudentActionItem {
  id            String                  @id @default(uuid())
  actionPlanId  String
  description   String
  ownerUserId   String
  dueDate       DateTime?
  status        StudentActionItemStatus @default(TODO)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  actionPlan    StudentActionPlan       @relation(fields: [actionPlanId], references: [id])
  owner         User                    @relation("ActionItemOwner", fields: [ownerUserId], references: [id])

  @@index([actionPlanId])
  @@index([ownerUserId])
}
